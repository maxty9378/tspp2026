<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="transparent">
    <title>–†–µ–π—Ç–∏–Ω–≥ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</title>
    <script src="https://unpkg.com/lottie-web@5.12.2/build/player/lottie.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        @font-face {
            font-family: 'SNS';
            src: url('SNS.OTF') format('opentype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }

        :root {
            --bg: transparent;
            --card: #11121a;
            --card-strong: #161823;
            --text: #f2f4fb;
            --muted: #9398a8;
            --line: rgba(255, 255, 255, 0.08);
            --accent: #63a8ff;
            --accent-2: #43e28f;
            --gold: #ffcc66;
            --silver: #b6becd;
            --bronze: #c59a6a;
            --shadow: 0 14px 50px rgba(0, 0, 0, 0.35);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        html, body {
            min-height: 100vh;
            min-height: 100dvh;
            background: var(--bg);
            color: var(--text);
            font-family: "Inter", -apple-system, system-ui, sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        html, body { 
            overflow-x: hidden;
            -ms-overflow-style: none;  /* IE –∏ Edge */
            scrollbar-width: none;  /* Firefox */
        }

        html::-webkit-scrollbar,
        body::-webkit-scrollbar {
            display: none;  /* Chrome, Safari, Opera */
        }

        .app {
            width: 100%;
            max-width: 760px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            background: var(--card);
            border: 1px solid var(--line);
            border-radius: 18px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .hero {
            position: relative;
            padding: 18px 16px 16px;
            background: linear-gradient(140deg, rgba(99, 168, 255, 0.2), rgba(67, 226, 143, 0.12) 50%, rgba(17, 18, 26, 0.92));
        }

        .hero__sticker {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 120px;
            height: 120px;
            pointer-events: none;
            opacity: 0.9;
        }

        .hero__meta {
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--muted);
            font-size: 13px;
        }

        .hero__badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.08);
            color: #fff;
            border-radius: 12px;
            border: 1px solid var(--line);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.25);
            font-weight: 700;
            letter-spacing: 0.2px;
        }

        .hero__title {
            position: relative;
            font-size: 26px;
            font-weight: 800;
            margin-top: 10px;
            letter-spacing: -0.3px;
        }

        .hero__subtitle {
            position: relative;
            margin-top: 6px;
            color: var(--muted);
            font-size: 14px;
        }

        .content {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 12px 12px 16px;
            background: #1c1c1e;
        }

        .podium {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 6px;
            padding: 20px 0 0;
            min-height: 220px;
        }

        .podium__item {
            flex: 1;
            max-width: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            animation: podiumRise 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) backwards;
        }

        .podium__item:nth-child(1) { animation-delay: 0.2s; }
        .podium__item:nth-child(2) { animation-delay: 0s; }
        .podium__item:nth-child(3) { animation-delay: 0.3s; }

        @keyframes podiumRise {
            from { opacity: 0; transform: translateY(40px) scale(0.8); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .podium__avatar {
            position: relative;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: grid;
            place-items: center;
            font-size: 28px;
            margin-bottom: 8px;
            z-index: 2;
        }

        /* –ó–æ–ª–æ—Ç–æ - 1 –º–µ—Å—Ç–æ */
        .podium__item--gold .podium__avatar {
            background: linear-gradient(145deg, #ffd700, #ffb347, #ffd700);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5), 0 0 40px rgba(255, 179, 71, 0.3), inset 0 2px 4px rgba(255, 255, 255, 0.4);
            animation: goldGlow 2s ease-in-out infinite alternate;
        }

        @keyframes goldGlow {
            from { box-shadow: 0 0 20px rgba(255, 215, 0, 0.5), 0 0 40px rgba(255, 179, 71, 0.3); }
            to { box-shadow: 0 0 30px rgba(255, 215, 0, 0.7), 0 0 60px rgba(255, 179, 71, 0.5); }
        }

        /* –°–µ—Ä–µ–±—Ä–æ - 2 –º–µ—Å—Ç–æ */
        .podium__item--silver .podium__avatar {
            background: linear-gradient(145deg, #e8e8e8, #b8c0cc, #d4d4d4);
            box-shadow: 0 0 15px rgba(184, 192, 204, 0.4), inset 0 2px 4px rgba(255, 255, 255, 0.5);
        }

        /* –ë—Ä–æ–Ω–∑–∞ - 3 –º–µ—Å—Ç–æ */
        .podium__item--bronze .podium__avatar {
            background: linear-gradient(145deg, #cd7f32, #8b5a2b, #cd7f32);
            box-shadow: 0 0 15px rgba(205, 127, 50, 0.4), inset 0 2px 4px rgba(255, 255, 255, 0.3);
        }

        .podium__sticker {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 70px;
            height: 70px;
            pointer-events: none;
            z-index: 1;
            opacity: 0;
            animation: stickerFlyIn 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) 0.5s forwards;
        }

        @keyframes stickerFlyIn {
            0% {
                opacity: 0;
                transform: translate(-50%, -20%) scale(0.3) rotate(-15deg);
            }
            60% {
                transform: translate(-50%, -50%) scale(1.15) rotate(5deg);
            }
            100% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1) rotate(0deg);
            }
        }

        .podium__sticker svg {
            width: 100%;
            height: 100%;
        }

        .podium__rank {
            font-family: 'SNS', sans-serif;
            font-size: 24px;
            font-weight: normal;
            color: #ffffff;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            position: relative;
            z-index: 5;
            animation: rankAppear 0.4s ease-out forwards;
        }

        @keyframes rankAppear {
            0% {
                opacity: 0;
                transform: scale(0.5);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        .podium__name {
            font-weight: 700;
            font-size: 13px;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            max-width: 100%;
            padding: 0 4px;
        }

        .podium__meta {
            margin-top: 2px;
            font-size: 11px;
            color: var(--muted);
            opacity: 0.8;
        }

        .podium__score {
            margin-top: 4px;
            font-size: 12px;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
        }

        .podium__item--gold .podium__score { color: var(--gold); background: rgba(255, 204, 102, 0.15); }
        .podium__item--silver .podium__score { color: var(--silver); background: rgba(182, 190, 205, 0.15); }
        .podium__item--bronze .podium__score { color: var(--bronze); background: rgba(197, 154, 106, 0.15); }

        .podium__pedestal {
            width: 100%;
            margin-top: 10px;
            border-radius: 8px 8px 0 0;
            position: relative;
            overflow: hidden;
        }

        .podium__pedestal::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        }

        .podium__item--gold .podium__pedestal {
            height: 80px;
            background: linear-gradient(180deg, rgba(255, 204, 102, 0.25) 0%, rgba(255, 179, 71, 0.1) 100%);
            border: 1px solid rgba(255, 204, 102, 0.3);
            border-bottom: none;
        }

        .podium__item--silver .podium__pedestal {
            height: 55px;
            background: linear-gradient(180deg, rgba(182, 190, 205, 0.2) 0%, rgba(143, 150, 167, 0.08) 100%);
            border: 1px solid rgba(182, 190, 205, 0.25);
            border-bottom: none;
        }

        .podium__item--bronze .podium__pedestal {
            height: 35px;
            background: linear-gradient(180deg, rgba(197, 154, 106, 0.2) 0%, rgba(140, 107, 63, 0.08) 100%);
            border: 1px solid rgba(197, 154, 106, 0.25);
            border-bottom: none;
        }

        /* –ü–æ—Ä—è–¥–æ–∫: 2-1-3 –≤–∏–∑—É–∞–ª—å–Ω–æ */
        .podium__item:nth-child(1) { order: 2; } /* –ó–æ–ª–æ—Ç–æ –≤ —Ü–µ–Ω—Ç—Ä–µ */
        .podium__item:nth-child(2) { order: 1; } /* –°–µ—Ä–µ–±—Ä–æ —Å–ª–µ–≤–∞ */
        .podium__item:nth-child(3) { order: 3; } /* –ë—Ä–æ–Ω–∑–∞ —Å–ø—Ä–∞–≤–∞ */

        .section-title {
            font-size: 12px;
            letter-spacing: 0.4px;
            color: var(--muted);
            text-transform: uppercase;
            padding: 0 2px;
        }

        .list {
            border: 1px solid var(--line);
            border-radius: 14px;
            overflow: hidden;
            background: var(--card-strong);
        }

        .row {
            display: grid;
            grid-template-columns: 38px 1fr auto;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-bottom: 1px solid var(--line);
            background: #292929;
        }

        .row--high {
            background: #292929;
        }

        .row:last-child { border-bottom: none; }

        .row__rank {
            width: 34px;
            height: 34px;
            border-radius: 10px;
            border: 1px solid var(--line);
            display: grid;
            place-items: center;
            color: var(--muted);
            font-weight: 600;
        }

        .row__name {
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            font-size: 15px;
            font-weight: 500;
        }

        .row__meta { font-size: 12px; color: var(--muted); margin-top: 2px; }

        .row__score {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border-radius: 12px;
            background: rgba(47, 140, 255, 0.12);
            color: var(--accent);
            font-weight: 700;
            font-size: 14px;
        }

        .row--high .row__score { background: rgba(67, 226, 143, 0.12); color: var(--accent-2); }
        .row--low .row__score { background: rgba(0, 0, 0, 0.04); color: var(--muted); }

        .state {
            padding: 32px 12px;
            text-align: center;
            color: var(--muted);
            border: 1px solid var(--line);
            border-radius: 12px;
            background: var(--card-strong);
        }

        .skeleton {
            position: relative;
            overflow: hidden;
            background: linear-gradient(90deg, rgba(0,0,0,0.04), rgba(0,0,0,0.08), rgba(0,0,0,0.04));
            background-size: 200% 100%;
            animation: shimmer 1.1s ease-in-out infinite;
        }

        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        /* –ë–ª–æ–∫ "–í–∞—à–µ –º–µ—Å—Ç–æ" */
        .my-place {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            background: linear-gradient(135deg, rgba(0, 163, 128, 0.15) 0%, rgba(0, 201, 154, 0.08) 100%);
            border: 1px solid rgba(0, 163, 128, 0.3);
            border-radius: 14px;
            margin-bottom: 8px;
        }

        .my-place__label {
            font-size: 13px;
            color: var(--muted);
        }

        .my-place__value {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .my-place__rank {
            font-family: 'SNS', sans-serif;
            font-size: 28px;
            font-weight: normal;
            color: #00a380;
            text-shadow: 0 2px 8px rgba(0, 163, 128, 0.3);
        }

        .my-place__name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
        }

        /* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–ø–∏—Å–∫–µ */
        .row--current {
            background: linear-gradient(135deg, rgba(0, 163, 128, 0.12) 0%, rgba(0, 201, 154, 0.06) 100%);
            border: 1px solid rgba(0, 163, 128, 0.25);
            border-radius: 12px;
            margin: 4px 0;
        }

        .row--current .row__rank {
            background: #00a380;
            color: #fff;
            border-color: #00a380;
        }

        .row--current .row__name {
            color: #00a380;
            font-weight: 700;
        }

        /* –û—Ç–ª–∞–¥–æ—á–Ω—ã–π –±–ª–æ–∫ */
        .debug-block {
            background: rgba(255, 100, 100, 0.15);
            border: 1px solid rgba(255, 100, 100, 0.3);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
            font-size: 11px;
            font-family: monospace;
        }

        .debug-block.success {
            background: rgba(0, 163, 128, 0.15);
            border-color: rgba(0, 163, 128, 0.3);
        }

        .debug-title {
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--text);
        }

        .debug-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .debug-row:last-child {
            border-bottom: none;
        }

        .debug-label {
            color: var(--muted);
        }

        .debug-value {
            color: var(--text);
            word-break: break-all;
            text-align: right;
            max-width: 60%;
        }

        @media (max-width: 520px) {
            .content { padding: 10px 10px 14px; }
            .podium { gap: 6px; }
            .row { grid-template-columns: 34px 1fr auto; }
        }

        @media (prefers-reduced-motion: reduce) { * { animation: none !important; transition: none !important; } }
    </style>
</head>
<body>
    <div class="app">
        <header class="hero">
            <div class="hero__meta">
                <span class="hero__badge">–û–Ω–ª–∞–π–Ω - –º–∞—Ä–∞—Ñ–æ–Ω</span>
            </div>
            <h1 class="hero__title">–†–µ–π—Ç–∏–Ω–≥ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</h1>
            <p class="hero__subtitle" id="subtitle">v3 - –ó–∞–≥—Ä—É–∑–∫–∞...</p>
            <div id="sticker" class="hero__sticker"></div>
        </header>

        <main class="content" id="content"></main>
    </div>

    <script>
        const API_URL = 'https://tspp2026.vercel.app/api/rating';
        const CACHE_KEY = 'puzzlebot-rating-cache-v2';
        
        // NocoDB –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∏–ª–∏–∞–ª–æ–≤
        const NOCODB_URL = 'https://nocodb.puzzlebot.top';
        const NOCODB_TOKEN = 'avKy8Ov_rNMIRMf-hgneulQKWsrXMhqmdqfc6uR1';

        const ui = {
            content: document.getElementById('content'),
            sticker: document.getElementById('sticker'),
            subtitle: document.getElementById('subtitle')
        };

        const themeFromTelegram = () => {
            const tg = window.Telegram?.WebApp;
            if (!tg) return;
            tg.ready();
            tg.expand();
            tg.disableVerticalSwipes?.();
            const p = tg.themeParams || {};
            const set = (k, v) => document.documentElement.style.setProperty(k, v);
            set('--card', p.secondary_bg_color ?? '#11121a');
            set('--card-strong', p.bg_color ?? '#161823');
            set('--text', p.text_color ?? '#f2f4fb');
            set('--muted', p.hint_color ?? '#9398a8');
            set('--accent', p.link_color ?? '#63a8ff');
            if (tg.setHeaderColor) tg.setHeaderColor('secondary_bg_color');
        };

        const loadSticker = () => {
            if (!window.lottie || !ui.sticker) return;
            try {
                window.lottie.loadAnimation({
                    container: ui.sticker,
                    renderer: 'svg',
                    loop: true,
                    autoplay: true,
                    path: 'AnimatedSticker.json'
                });
            } catch (_) { /* ignore */ }
        };

        let winnerStickerAnimation = null;
        const loadWinnerSticker = () => {
            if (!window.lottie) return;
            const el = document.getElementById('winner-sticker');
            if (!el) return;
            el.innerHTML = '';
            if (winnerStickerAnimation) {
                winnerStickerAnimation.destroy();
                winnerStickerAnimation = null;
            }
            winnerStickerAnimation = window.lottie.loadAnimation({
                container: el,
                renderer: 'svg',
                loop: true,
                autoplay: true,
                path: 'AnimatedSticker-01.json'
            });
        };

        const skeletonPodium = () => `
            <div class="podium">
                ${['silver', 'gold', 'bronze'].map((place, i) => `
                    <div class="podium__item podium__item--${place}" style="opacity: 0.5;">
                        <div class="podium__avatar skeleton" style="width:56px;height:56px;border-radius:50%;"></div>
                        <div class="podium__name skeleton" style="height:14px;width:70%;margin:8px auto 0;"></div>
                        <div class="podium__score skeleton" style="height:20px;width:50px;margin-top:6px;border-radius:10px;"></div>
                        <div class="podium__pedestal"></div>
                    </div>
                `).join('')}
            </div>
        `;

        const skeletonList = (rows = 4) => `
            <div class="section-title">–°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div>
            <div class="list">
                ${[...Array(rows)].map(() => `
                    <div class="row">
                        <div class="row__rank skeleton"></div>
                        <div class="row__name skeleton" style="height:14px;"></div>
                        <div class="row__score skeleton" style="width:56px; height:18px;"></div>
                    </div>
                `).join('')}
            </div>
        `;

        const shortName = (fio = '') => {
            const parts = fio.trim().split(/\s+/);
            if (parts.length >= 2) return `${parts[0]} ${parts[1][0] || ''}.`;
            return fio || '–ë–µ–∑ –∏–º–µ–Ω–∏';
        };

        const classifyScore = (score) => {
            if (score >= 4) return 'row--high';
            if (score <= 1) return 'row--low';
            return '';
        };

        const render = (state) => {
            const { data, loading, error, currentUserIndex, currentUserFio } = state;

            if (loading && !data.length) {
                ui.content.innerHTML = skeletonPodium() + skeletonList(6);
                if (ui.subtitle) ui.subtitle.textContent = '–ó–∞–≥—Ä—É–∂–∞–µ–º...';
                return;
            }

            if (error && !data.length) {
                ui.content.innerHTML = `<div class="state">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ–π—Ç–∏–Ω–≥. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å –ø–æ–∑–∂–µ.</div>`;
                if (ui.subtitle) ui.subtitle.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
                return;
            }

            const podium = data.slice(0, 3);
            const rest = data.slice(3);

            let html = '';

            // –û—Ç–ª–∞–¥–æ—á–Ω—ã–π –±–ª–æ–∫ (–º–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
            const tabNumber = getTabNumber();
            const tg = window.Telegram?.WebApp;
            const isDebug = true; // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ false —á—Ç–æ–±—ã —Å–∫—Ä—ã—Ç—å
            
            if (isDebug) {
                const isFound = currentUserIndex >= 0;
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ tabNomer –≤ –¥–∞–Ω–Ω—ã—Ö
                const hasTabNomer = data.some(d => d.tabNomer);
                html += `
                    <div class="debug-block ${isFound ? 'success' : ''}">
                        <div class="debug-title">üîç v5</div>
                        <div class="debug-row">
                            <span class="debug-label">?tab=</span>
                            <span class="debug-value">${tabNumber || '‚ùå –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω'}</span>
                        </div>
                        <div class="debug-row">
                            <span class="debug-label">URL:</span>
                            <span class="debug-value" style="font-size: 9px;">${window.location.search || '(–ø—É—Å—Ç–æ)'}</span>
                        </div>
                        <div class="debug-row">
                            <span class="debug-label">API tabNomer:</span>
                            <span class="debug-value">${hasTabNomer ? '‚úÖ' : '‚ùå –Ω–µ—Ç –≤ –¥–∞–Ω–Ω—ã—Ö'}</span>
                        </div>
                        <div class="debug-row">
                            <span class="debug-label">–ù–∞–π–¥–µ–Ω:</span>
                            <span class="debug-value">${isFound ? '‚úÖ #' + (currentUserIndex + 1) : '‚ùå'}</span>
                        </div>
                        ${isFound ? `
                        <div class="debug-row">
                            <span class="debug-label">–§–ò–û:</span>
                            <span class="debug-value">${currentUserFio}</span>
                        </div>
                        ` : ''}
                    </div>
                `;
            }

            // –ë–ª–æ–∫ "–í–∞—à–µ –º–µ—Å—Ç–æ" –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω
            if (currentUserIndex >= 0) {
                const userScore = data[currentUserIndex]?.score || 0;
                html += `
                    <div class="my-place">
                        <div>
                            <div class="my-place__label">–í–∞—à–µ –º–µ—Å—Ç–æ –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ</div>
                            <div class="my-place__name">${shortName(currentUserFio)}</div>
                        </div>
                        <div class="my-place__value">
                            <span class="my-place__rank">#${currentUserIndex + 1}</span>
                            <span style="font-size: 14px; color: var(--muted);">${userScore} ‚≠ê</span>
                        </div>
                    </div>
                `;
            }

            if (podium.length) {
                const placeClass = ['gold', 'silver', 'bronze'];
                
                html += '<div class="podium">';
                podium.forEach((item, idx) => {
                    const isCurrent = idx === currentUserIndex;
                    html += `
                        <div class="podium__item podium__item--${placeClass[idx] || 'bronze'}${isCurrent ? ' podium__item--current' : ''}">
                            <div class="podium__avatar">
                                ${idx === 0 ? `<div id="winner-sticker" class="podium__sticker"></div>` : ''}
                                <span class="podium__rank">${idx + 1}</span>
                            </div>
                            <div class="podium__name" title="${item.fio}">${shortName(item.fio)}${isCurrent ? ' (–≤—ã)' : ''}</div>
                            ${item.filial && item.filial.trim() ? `<div class="podium__meta">${item.filial}</div>` : ''}
                            <div class="podium__score">${item.score} ‚≠ê</div>
                            <div class="podium__pedestal"></div>
                        </div>
                    `;
                });
                html += '</div>';
            }

            html += '<div class="section-title">–°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div>';
            html += '<div class="list">';

            if (!rest.length && podium.length === 0) {
                html += `<div class="state" style="border:none;">–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>`;
            } else {
                const rows = rest.length ? rest : podium;
                rows.forEach((item, idx) => {
                    const rank = podium.length ? idx + podium.length + 1 : idx + 1;
                    const actualIndex = podium.length ? idx + podium.length : idx;
                    const isCurrent = actualIndex === currentUserIndex;
                    html += `
                        <div class="row ${classifyScore(item.score)}${isCurrent ? ' row--current' : ''}">
                            <div class="row__rank">${rank}</div>
                            <div>
                                <div class="row__name" title="${item.fio}">${shortName(item.fio)}${isCurrent ? ' (–≤—ã)' : ''}</div>
                                ${item.filial && item.filial.trim() ? `<div class="row__meta">${item.filial}</div>` : ''}
                            </div>
                            <div class="row__score">${item.score}</div>
                        </div>
                    `;
                });
            }

            html += '</div>';

            ui.content.innerHTML = html;
            loadWinnerSticker();
            if (ui.subtitle) {
                const ts = new Date();
                ui.subtitle.textContent = `–û–±–Ω–æ–≤–ª–µ–Ω–æ –≤ ${ts.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' })}`;
            }
        };

        const parseData = (raw = []) => raw
            .map((item, idx) => {
                const fio = (item.fio || `–£—á–∞—Å—Ç–Ω–∏–∫ ${idx + 1}`).trim();
                let filial = (item.filial || item.branch || item.city || item.location || item.place || '').trim();
                if (!filial) {
                    const key = Object.keys(item).find(k => /filial|—Ñ–∏–ª–∏–∞–ª/i.test(k));
                    if (key) filial = String(item[key] || '').trim();
                }
                const score = Number.isFinite(Number(item.score)) ? Number(item.score) : 0;
                return { fio, filial: filial || '', score };
            })
            .sort((a, b) => b.score - a.score);

        const saveCache = (payload) => { try { localStorage.setItem(CACHE_KEY, JSON.stringify(payload)); } catch (_) {} };
        const readCache = () => { try { const raw = localStorage.getItem(CACHE_KEY); return raw ? JSON.parse(raw) : null; } catch (_) { return null; } };

        const state = { 
            data: [], 
            loading: true, 
            error: '', 
            updatedAt: null, 
            filialMap: {},
            tgUserMap: {},   // –ö–∞—Ä—Ç–∞: Telegram ID ‚Üí {tabNum, fio}
            tabUserMap: {},  // –ö–∞—Ä—Ç–∞: –¢–∞–±–µ–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä ‚Üí –§–ò–û
            currentUserIndex: -1,
            currentUserFio: ''
        };

        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–∞–±–µ–ª—å–Ω–æ–≥–æ –Ω–æ–º–µ—Ä–∞ –∏–∑ URL (?tab=...)
        const getTabNumber = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const tab = urlParams.get('tab') || urlParams.get('tab_nomer') || urlParams.get('tabnomer');
            if (tab) {
                console.log('–¢–∞–±. –Ω–æ–º–µ—Ä –∏–∑ URL:', tab);
                return String(tab).trim();
            }
            return null;
        };

        // –ü–æ–ª—É—á–µ–Ω–∏–µ Telegram ID —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–º–Ω–æ–∂–µ—Å—Ç–≤–æ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤)
        const getTelegramUserId = () => {
            let tgId = null;
            
            // 1. –ò–∑ Telegram WebApp API
            const tg = window.Telegram?.WebApp;
            if (tg?.initDataUnsafe?.user?.id) {
                tgId = tg.initDataUnsafe.user.id;
                console.log('TG ID –∏–∑ WebApp API:', tgId);
                return String(tgId);
            }
            
            // 2. –ò–∑ URL-–ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (?tg_id=... –∏–ª–∏ ?user_id=...)
            const urlParams = new URLSearchParams(window.location.search);
            tgId = urlParams.get('tg_id') || urlParams.get('user_id') || urlParams.get('tg_user_id');
            if (tgId) {
                console.log('TG ID –∏–∑ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤:', tgId);
                return String(tgId);
            }
            
            // 3. –ò–∑ hash-–ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (#tg_id=...)
            if (window.location.hash) {
                const hashParams = new URLSearchParams(window.location.hash.substring(1));
                tgId = hashParams.get('tg_id') || hashParams.get('user_id');
                if (tgId) {
                    console.log('TG ID –∏–∑ hash:', tgId);
                    return String(tgId);
                }
            }
            
            // 4. –ò–∑ startParam (–µ—Å–ª–∏ –±–æ—Ç –æ—Ç–∫—Ä—ã–ª Mini App —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º)
            if (tg?.initDataUnsafe?.start_param) {
                const startParam = tg.initDataUnsafe.start_param;
                // –ï—Å–ª–∏ startParam —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã ‚Äî —ç—Ç–æ tg_id
                if (/^\d+$/.test(startParam)) {
                    console.log('TG ID –∏–∑ startParam:', startParam);
                    return startParam;
                }
            }
            
            console.log('TG ID –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return null;
        };
        
        // –ü–æ–ª—É—á–µ–Ω–∏–µ –§–ò–û –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
        const getUserFullName = () => {
            let fullname = null;
            const tg = window.Telegram?.WebApp;
            
            // 1. –ò–∑ URL-–ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
            const urlParams = new URLSearchParams(window.location.search);
            fullname = urlParams.get('fullname') || urlParams.get('full_name') || urlParams.get('fio');
            if (fullname) {
                console.log('–§–ò–û –∏–∑ URL:', fullname);
                return decodeURIComponent(fullname);
            }
            
            // 2. –ò–∑ Telegram WebApp
            if (tg?.initDataUnsafe?.user) {
                const user = tg.initDataUnsafe.user;
                if (user.last_name && user.first_name) {
                    fullname = user.last_name + ' ' + user.first_name;
                } else if (user.first_name) {
                    fullname = user.first_name;
                }
                if (fullname) {
                    console.log('–§–ò–û –∏–∑ WebApp:', fullname);
                    return fullname;
                }
            }
            
            return null;
        };

        // Haptic Feedback
        const haptic = {
            light: () => window.Telegram?.WebApp?.HapticFeedback?.impactOccurred?.('light'),
            medium: () => window.Telegram?.WebApp?.HapticFeedback?.impactOccurred?.('medium'),
            success: () => window.Telegram?.WebApp?.HapticFeedback?.notificationOccurred?.('success'),
            error: () => window.Telegram?.WebApp?.HapticFeedback?.notificationOccurred?.('error')
        };

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∏–ª–∏–∞–ª–æ–≤ –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Å NocoDB
        const loadExtraData = async () => {
            try {
                const headers = { 'xc-token': NOCODB_TOKEN };
                
                // 1. –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ–µ–∫—Ç—ã
                const projRes = await fetch(NOCODB_URL + '/api/v1/db/meta/projects', { headers });
                const projects = (await projRes.json()).list || [];
                const projectId = projects.find(p => p.title?.toLowerCase().includes('—Ç–µ–ª–µ–≥—Ä–∞–º'))?.id || projects[0]?.id;
                if (!projectId) return { filialMap: {}, tgUserMap: {} };
                
                // 2. –ü–æ–ª—É—á–∞–µ–º —Ç–∞–±–ª–∏—Ü—ã
                const tabRes = await fetch(NOCODB_URL + '/api/v1/db/meta/projects/' + projectId + '/tables', { headers });
                const tables = (await tabRes.json()).list || [];
                
                const filialMap = {};
                const tgUserMap = {};
                const tabUserMap = {};
                
                // 3. –î–∞–Ω–Ω—ã–µ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã "–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏" –¥–ª—è —Ñ–∏–ª–∏–∞–ª–æ–≤
                const empTableId = tables.find(t => t.title === '–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏')?.id;
                if (empTableId) {
                    const empRes = await fetch(NOCODB_URL + '/api/v1/db/data/noco/' + projectId + '/' + empTableId, { headers });
                    const employees = (await empRes.json()).list || [];
                    employees.forEach(emp => {
                        const fio = emp['–§–ò–û —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞'] || emp['–§–ò–û'] || '';
                        const filial = emp['–§–∏–ª–∏–∞–ª —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞'] || emp['–§–∏–ª–∏–∞–ª'] || '';
                        if (fio && filial) {
                            filialMap[String(fio).trim()] = String(filial).trim();
                        }
                    });
                }
                
                // 4. –î–∞–Ω–Ω—ã–µ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–∞" –¥–ª—è —Å–≤—è–∑–∏ Telegram ID ‚Üí —Ç–∞–±–µ–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä
                const regTableId = tables.find(t => 
                    t.title === '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–∞' || 
                    t.title?.toLowerCase().includes('—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü')
                )?.id;
                
                if (regTableId) {
                    const regRes = await fetch(NOCODB_URL + '/api/v1/db/data/noco/' + projectId + '/' + regTableId, { headers });
                    const registrations = (await regRes.json()).list || [];
                    registrations.forEach(reg => {
                        const tgId = reg['ID TG USER'] || reg['id_tg_user'] || reg['tg_id'] || '';
                        const tabNum = reg['–¢–∞–±–µ–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä'] || reg['tab_nomer'] || reg['Tab_nomer'] || '';
                        const fio = reg['–§–ò–û'] || reg['–§–ò–û —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞'] || reg['fio'] || '';
                        
                        // –ö–∞—Ä—Ç–∞ –ø–æ Telegram ID
                        if (tgId) {
                            tgUserMap[String(tgId).trim()] = {
                                tabNum: String(tabNum).trim(),
                                fio: String(fio).trim()
                            };
                        }
                        
                        // –ö–∞—Ä—Ç–∞ –ø–æ —Ç–∞–±–µ–ª—å–Ω–æ–º—É –Ω–æ–º–µ—Ä—É
                        if (tabNum) {
                            tabUserMap[String(tabNum).trim()] = String(fio).trim();
                        }
                    });
                    console.log('–ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–π:', Object.keys(tgUserMap).length, '—Ç–∞–±–µ–ª—å–Ω—ã—Ö:', Object.keys(tabUserMap).length);
                }
                
                console.log('–ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ñ–∏–ª–∏–∞–ª–æ–≤:', Object.keys(filialMap).length);
                return { filialMap, tgUserMap, tabUserMap };
            } catch (e) {
                console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ:', e);
                return { filialMap: {}, tgUserMap: {}, tabUserMap: {} };
            }
        };

        const fetchRating = async (withSkeleton = false) => {
            if (withSkeleton) { state.loading = true; state.error = ''; render(state); }
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ä–µ–π—Ç–∏–Ω–≥–∞ –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
                const needExtraData = !Object.keys(state.filialMap).length;
                const [ratingRes, extraData] = await Promise.all([
                    fetch(API_URL, { cache: 'no-store' }).then(r => r.json()),
                    needExtraData ? loadExtraData() : Promise.resolve({ filialMap: state.filialMap, tgUserMap: state.tgUserMap, tabUserMap: state.tabUserMap })
                ]);
                
                if (!ratingRes.success) throw new Error(ratingRes.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
                
                state.filialMap = extraData.filialMap;
                state.tgUserMap = extraData.tgUserMap;
                state.tabUserMap = extraData.tabUserMap || {};
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–ª–∏–∞–ª—ã –∫ –¥–∞–Ω–Ω—ã–º
                const dataWithFilials = (ratingRes.data || []).map(item => ({
                    ...item,
                    filial: state.filialMap[String(item.fio || '').trim()] || item.filial || ''
                }));
                
                state.data = parseData(dataWithFilials);
                
                // –ü–æ–∏—Å–∫ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                state.currentUserIndex = -1;
                state.currentUserFio = '';
                
                // –°–ø–æ—Å–æ–± 0: –ü–æ —Ç–∞–±–µ–ª—å–Ω–æ–º—É –Ω–æ–º–µ—Ä—É –∏–∑ URL (?tab=...) ‚Äî –∏—â–µ–º –ø—Ä—è–º–æ –≤ –¥–∞–Ω–Ω—ã—Ö —Ä–µ–π—Ç–∏–Ω–≥–∞
                const tabNumber = getTabNumber();
                if (tabNumber) {
                    state.currentUserIndex = state.data.findIndex(d => 
                        String(d.tabNomer || '').trim() === tabNumber
                    );
                    if (state.currentUserIndex >= 0) {
                        state.currentUserFio = state.data[state.currentUserIndex].fio;
                    }
                    console.log('–ü–æ–∏—Å–∫ –ø–æ —Ç–∞–±. –Ω–æ–º–µ—Ä—É:', { tabNumber, index: state.currentUserIndex, fio: state.currentUserFio });
                }
                
                // –°–ø–æ—Å–æ–± 1: –ü–æ Telegram ID –∏–∑ —Ç–∞–±–ª–∏—Ü—ã —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
                const tgUserId = getTelegramUserId();
                if (tgUserId && state.tgUserMap[tgUserId]) {
                    const userData = state.tgUserMap[tgUserId];
                    if (userData.fio) {
                        const searchFio = userData.fio.toLowerCase().trim();
                        state.currentUserIndex = state.data.findIndex(d => {
                            const dataFio = d.fio.toLowerCase().trim();
                            return dataFio === searchFio || 
                                   dataFio.includes(searchFio) || 
                                   searchFio.includes(dataFio);
                        });
                        if (state.currentUserIndex >= 0) {
                            state.currentUserFio = state.data[state.currentUserIndex].fio;
                        }
                    }
                    console.log('–ü–æ–∏—Å–∫ –ø–æ TG ID:', { tgUserId, userData, index: state.currentUserIndex });
                }
                
                // –°–ø–æ—Å–æ–± 2: –ü–æ –§–ò–û –Ω–∞–ø—Ä—è–º—É—é (–∏–∑ URL –∏–ª–∏ Telegram)
                if (state.currentUserIndex < 0) {
                    const fullname = getUserFullName();
                    if (fullname) {
                        const searchFio = fullname.toLowerCase().trim();
                        state.currentUserIndex = state.data.findIndex(d => {
                            const dataFio = d.fio.toLowerCase().trim();
                            return dataFio === searchFio || 
                                   dataFio.includes(searchFio) || 
                                   searchFio.includes(dataFio);
                        });
                        if (state.currentUserIndex >= 0) {
                            state.currentUserFio = state.data[state.currentUserIndex].fio;
                        }
                        console.log('–ü–æ–∏—Å–∫ –ø–æ –§–ò–û:', { fullname, index: state.currentUserIndex });
                    }
                }
                
                console.log('–ò—Ç–æ–≥–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:', { 
                    tgUserId, 
                    currentUserIndex: state.currentUserIndex, 
                    currentUserFio: state.currentUserFio 
                });
                
                state.loading = false;
                state.error = '';
                state.updatedAt = Date.now();
                saveCache({ data: state.data, updatedAt: state.updatedAt });
                render(state);
                
                // Haptic feedback –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–µ
                haptic.success();
            } catch (err) {
                state.loading = false;
                state.error = err.message || '–û—à–∏–±–∫–∞';
                render(state);
                
                // Haptic feedback –ø—Ä–∏ –æ—à–∏–±–∫–µ
                haptic.error();
            }
        };

        const init = () => {
            themeFromTelegram();
            loadSticker();
            let cached = readCache();
            
            // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ –∫—ç—à–∞ –±–µ–∑ —Ñ–∏–ª–∏–∞–ª–æ–≤
            if (cached?.data?.length) {
                const hasFilial = cached.data.some(item => item.filial);
                if (!hasFilial) {
                    console.log('–û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ –±–µ–∑ —Ñ–∏–ª–∏–∞–ª–æ–≤');
                    localStorage.removeItem(CACHE_KEY);
                    cached = null;
                }
            }
            
            if (cached?.data?.length) {
                state.data = cached.data;
                state.loading = false;
                state.updatedAt = cached.updatedAt;
                render(state);
            } else {
                render(state);
            }
            fetchRating(!cached);
            setInterval(fetchRating, 30000);
        };

        init();
    </script>
</body>
</html>
