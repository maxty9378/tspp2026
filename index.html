<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–†–µ–π—Ç–∏–Ω–≥ - –î–µ–Ω—å 1</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@nicepkg/tgs-player@latest/dist/tgs-player.min.js"></script>
    <style>
        :root {
            /* –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ —Ü–≤–µ—Ç–∞ */
            --primary: #00a380;
            --on-surface-variant: #5e5e5e;
            --surface-hover: #ececec;
            --surface-disable: #787880;
            
            /* Telegram fallback */
            --tg-bg: var(--tg-theme-bg-color, #000000);
            --tg-text: var(--tg-theme-text-color, #FFFFFF);
            --tg-hint: var(--tg-theme-hint-color, #5e5e5e);
            --tg-link: var(--tg-theme-link-color, #00a380);
            --tg-button: var(--tg-theme-button-color, #00a380);
            --tg-secondary-bg: var(--tg-theme-secondary-bg-color, #1C1C1E);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-bg);
            color: var(--tg-text);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .container {
            padding: 16px;
            padding-bottom: calc(16px + env(safe-area-inset-bottom, 0px));
        }
        
        .header {
            text-align: center;
            padding: 20px 0;
        }
        
        .sticker-container {
            width: 80px;
            height: 80px;
            margin: 0 auto 12px;
        }
        
        tgs-player {
            width: 80px;
            height: 80px;
        }
        
        .fallback-icon {
            font-size: 64px;
            display: block;
            text-align: center;
        }
        
        .title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .subtitle {
            font-size: 15px;
            color: var(--tg-hint);
        }
        
        .debug-block {
            background: rgba(0, 163, 128, 0.15);
            border: 1px solid rgba(0, 163, 128, 0.3);
            border-radius: 12px;
            padding: 12px;
            margin: 16px 0;
            text-align: center;
            font-size: 12px;
        }
        
        .debug-block.error {
            background: rgba(255, 59, 48, 0.15);
            border-color: rgba(255, 59, 48, 0.3);
        }
        
        .debug-label {
            color: var(--tg-hint);
            margin-bottom: 4px;
        }
        
        .debug-value {
            font-size: 16px;
            font-weight: 700;
            color: #00a380;
        }
        
        .my-place {
            background: rgba(0, 163, 128, 0.15);
            border: 1px solid rgba(0, 163, 128, 0.3);
            border-radius: 16px;
            padding: 16px;
            margin: 16px 0;
            text-align: center;
        }
        
        .my-place-label {
            font-size: 13px;
            color: var(--tg-hint);
            margin-bottom: 8px;
        }
        
        .my-place-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--tg-link);
        }
        
        .podium {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 8px;
            margin: 24px 0;
            padding: 0 8px;
        }
        
        .podium-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            max-width: 110px;
        }
        
        .podium-avatar {
            width: 56px;
            height: 56px;
            border-radius: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 8px;
        }
        
        .podium-item.gold .podium-avatar {
            width: 68px;
            height: 68px;
            font-size: 28px;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            box-shadow: 0 4px 20px rgba(255, 215, 0, 0.4);
        }
        
        .podium-item.silver .podium-avatar {
            background: linear-gradient(135deg, #C0C0C0, #A0A0A0);
            box-shadow: 0 4px 15px rgba(192, 192, 192, 0.3);
        }
        
        .podium-item.bronze .podium-avatar {
            background: linear-gradient(135deg, #CD7F32, #8B4513);
            box-shadow: 0 4px 15px rgba(205, 127, 50, 0.3);
        }
        
        .podium-name {
            font-size: 13px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 2px;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .podium-filial {
            font-size: 10px;
            color: var(--tg-hint);
            text-align: center;
            margin-bottom: 4px;
        }
        
        .podium-score {
            font-size: 14px;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 12px;
            background: var(--tg-secondary-bg);
        }
        
        .podium-item.gold .podium-score {
            background: rgba(255, 215, 0, 0.2);
            color: #FFD700;
        }
        
        .podium-pedestal {
            width: 100%;
            margin-top: 10px;
            border-radius: 8px 8px 0 0;
            background: var(--tg-secondary-bg);
        }
        
        .podium-item.gold .podium-pedestal { height: 60px; }
        .podium-item.silver .podium-pedestal { height: 45px; }
        .podium-item.bronze .podium-pedestal { height: 30px; }
        
        .section-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--tg-hint);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 16px 0 8px;
        }
        
        .list {
            background: var(--tg-secondary-bg);
            border-radius: 12px;
            overflow: hidden;
        }
        
        .item {
            display: flex;
            align-items: center;
            padding: 12px 14px;
            gap: 12px;
            border-bottom: 0.5px solid rgba(84, 84, 88, 0.4);
        }
        
        .item:last-child {
            border-bottom: none;
        }
        
        .item.current {
            background: rgba(0, 163, 128, 0.1);
            border-left: 3px solid var(--tg-link);
        }
        
        .rank {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 600;
            background: rgba(84, 84, 88, 0.3);
            color: var(--tg-hint);
            flex-shrink: 0;
        }
        
        .item.current .rank {
            background: var(--tg-link);
            color: #fff;
        }
        
        .info {
            flex: 1;
            min-width: 0;
        }
        
        .name {
            font-size: 15px;
            font-weight: 500;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .item.current .name {
            font-weight: 600;
            color: var(--tg-link);
        }
        
        .filial {
            font-size: 12px;
            color: var(--tg-hint);
            margin-top: 2px;
        }
        
        .score {
            padding: 6px 12px;
            border-radius: 16px;
            background: rgba(0, 163, 128, 0.15);
            color: var(--tg-link);
            font-size: 14px;
            font-weight: 700;
            flex-shrink: 0;
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            font-size: 12px;
            color: var(--tg-hint);
        }
        
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: var(--tg-hint);
        }
        
        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--tg-secondary-bg);
            border-top-color: var(--tg-link);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .error {
            text-align: center;
            padding: 40px 20px;
            color: var(--tg-hint);
        }
        
        .error-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="sticker-container" id="sticker">
                <span class="fallback-icon">üèÜ</span>
            </div>
            <h1 class="title">–†–µ–π—Ç–∏–Ω–≥</h1>
            <div class="subtitle">–î–µ–Ω—å 1 ‚Ä¢ –ú–∞—Ä–∞—Ñ–æ–Ω</div>
        </div>
        
        <div id="debug"></div>
        <div id="content">
            <div class="loading">
                <div class="spinner"></div>
                <div>–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
        </div>
        <div class="footer" id="footer"></div>
    </div>

<script>
// === Telegram WebApp ===
const tg = window.Telegram?.WebApp;
if (tg) {
    tg.ready();
    tg.expand();
    tg.enableClosingConfirmation();
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–º—É Telegram
    document.documentElement.style.setProperty('--tg-theme-bg-color', tg.themeParams.bg_color || '#000000');
    document.documentElement.style.setProperty('--tg-theme-text-color', tg.themeParams.text_color || '#FFFFFF');
    document.documentElement.style.setProperty('--tg-theme-hint-color', tg.themeParams.hint_color || '#5e5e5e');
    document.documentElement.style.setProperty('--tg-theme-link-color', tg.themeParams.link_color || '#00a380');
    document.documentElement.style.setProperty('--tg-theme-button-color', tg.themeParams.button_color || '#00a380');
    document.documentElement.style.setProperty('--tg-theme-secondary-bg-color', tg.themeParams.secondary_bg_color || '#1C1C1E');
}

// === –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ===
const NOCODB_URL = 'https://nocodb.puzzlebot.top';
const API_TOKEN = 'avKy8Ov_rNMIRMf-hgneulQKWsrXMhqmdqfc6uR1';
const TABLE_NAME = '–î–µ–Ω—å 1';

// === –£—Ç–∏–ª–∏—Ç—ã ===
function shortName(fio) {
    const parts = String(fio).trim().split(/\s+/).filter(x => x);
    if (parts.length >= 2) {
        return parts[1] + ' ' + parts[0][0].toUpperCase() + '.';
    }
    return fio;
}

// === –ü–æ–ª—É—á–µ–Ω–∏–µ fullname –∏–∑ Telegram WebApp –∏–ª–∏ URL ===
function getFullName() {
    let fullname = null;
    
    // 1. –ò–∑ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    const urlParams = new URLSearchParams(window.location.search);
    fullname = urlParams.get('fullname') || urlParams.get('fullName');
    
    // 2. –ò–∑ hash –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    if (!fullname && window.location.hash) {
        const hashParams = new URLSearchParams(window.location.hash.substring(1));
        fullname = hashParams.get('fullname') || hashParams.get('fullName');
    }
    
    // 3. –ò–∑ Telegram WebApp
    if (!fullname && tg) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º initDataUnsafe.user
        if (tg.initDataUnsafe?.user) {
            const user = tg.initDataUnsafe.user;
            if (user.last_name && user.first_name) {
                fullname = user.last_name + ' ' + user.first_name;
            } else if (user.first_name) {
                fullname = user.first_name;
            }
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–µ –ø–æ–ª—è
        if (!fullname && tg.initDataUnsafe) {
            fullname = tg.initDataUnsafe.fullname || tg.initDataUnsafe.fullName || tg.initDataUnsafe.FullName;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º initData
        if (!fullname && tg.initData) {
            const initData = new URLSearchParams(tg.initData);
            fullname = initData.get('fullname') || initData.get('fullName');
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º startParam
        if (!fullname && tg.startParam) {
            if (tg.startParam.includes('fullname=')) {
                const match = tg.startParam.match(/fullname=([^&]+)/i);
                if (match) fullname = decodeURIComponent(match[1]);
            }
        }
    }
    
    // 4. –ü—Ä–æ–±—É–µ–º PuzzleBot –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    if (!fullname) {
        try {
            fullname = window.fullname || window.fullName;
        } catch (e) {}
    }
    
    return fullname ? String(fullname).trim() : null;
}

// === –ü–æ–ª—É—á–µ–Ω–∏–µ tab_nomer ===
function getTabNomer() {
    let tabN = null;
    
    // 1. –ò–∑ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    const urlParams = new URLSearchParams(window.location.search);
    tabN = urlParams.get('tab_nomer') || urlParams.get('Tab_nomer') || urlParams.get('tab_n');
    
    // 2. –ò–∑ hash
    if (!tabN && window.location.hash) {
        const hashParams = new URLSearchParams(window.location.hash.substring(1));
        tabN = hashParams.get('tab_nomer') || hashParams.get('Tab_nomer');
    }
    
    // 3. –ò–∑ Telegram WebApp
    if (!tabN && tg) {
        if (tg.initDataUnsafe) {
            tabN = tg.initDataUnsafe.tab_nomer || tg.initDataUnsafe.Tab_nomer;
        }
        if (!tabN && tg.initData) {
            const initData = new URLSearchParams(tg.initData);
            tabN = initData.get('tab_nomer') || initData.get('Tab_nomer');
        }
        if (!tabN && tg.startParam) {
            if (tg.startParam.includes('tab_nomer=')) {
                const match = tg.startParam.match(/tab_nomer=([^&]+)/i);
                if (match) tabN = decodeURIComponent(match[1]);
            }
        }
    }
    
    // 4. PuzzleBot –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    if (!tabN) {
        try {
            tabN = window.tab_nomer || window.Tab_nomer;
        } catch (e) {}
    }
    
    return tabN ? String(tabN).trim() : null;
}

// === –ü–æ–∫–∞–∑–∞—Ç—å –±–ª–æ–∫ –æ—Ç–ª–∞–¥–∫–∏ ===
function showDebug() {
    const fullname = getFullName();
    const tabN = getTabNomer();
    const debugEl = document.getElementById('debug');
    
    let html = '';
    
    if (fullname || tabN) {
        html = `<div class="debug-block">`;
        if (fullname) {
            html += `<div class="debug-label">‚úÖ –§–ò–û:</div>
                     <div class="debug-value">${fullname}</div>`;
        }
        if (tabN) {
            html += `<div class="debug-label" style="margin-top: 8px;">‚úÖ –¢–∞–±–µ–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä:</div>
                     <div class="debug-value">${tabN}</div>`;
        }
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö
        let source = '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
        if (tg?.initDataUnsafe?.user) source = 'Telegram User';
        else if (tg?.initDataUnsafe?.fullname) source = 'Telegram initDataUnsafe';
        else if (tg?.startParam) source = 'Telegram startParam';
        else if (window.location.search) source = 'URL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã';
        html += `<div style="font-size: 10px; color: var(--tg-hint); margin-top: 8px;">–ò—Å—Ç–æ—á–Ω–∏–∫: ${source}</div>`;
        html += `</div>`;
    } else {
        html = `<div class="debug-block error">
            <div class="debug-label">‚ùå –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>
            <div style="font-size: 10px; color: var(--tg-hint); margin-top: 8px; word-break: break-all;">
                URL: ${window.location.href}<br>
                Telegram: ${tg ? '–ø–æ–¥–∫–ª—é—á–µ–Ω' : '–Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω'}<br>
                ${tg?.initData ? 'initData: –µ—Å—Ç—å' : 'initData: –Ω–µ—Ç'}
            </div>
        </div>`;
    }
    
    debugEl.innerHTML = html;
}

// === –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∏–∫–µ—Ä–∞ ===
async function loadSticker() {
    const container = document.getElementById('sticker');
    if (!container) return;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ tgs-player
    if (typeof customElements !== 'undefined' && customElements.get('tgs-player')) {
        try {
            const tgsPlayer = document.createElement('tgs-player');
            tgsPlayer.setAttribute('src', '/AnimatedSticker.tgs');
            tgsPlayer.setAttribute('autoplay', '');
            tgsPlayer.setAttribute('loop', '');
            tgsPlayer.style.width = '80px';
            tgsPlayer.style.height = '80px';
            container.innerHTML = '';
            container.appendChild(tgsPlayer);
            console.log('TGS Player –∑–∞–≥—Ä—É–∂–µ–Ω');
            return;
        } catch (e) {
            console.warn('–û—à–∏–±–∫–∞ TGS Player:', e);
        }
    }
    
    // Fallback: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–º–æ–¥–∑–∏
    container.innerHTML = '<span class="fallback-icon">üèÜ</span>';
}

// === –†–µ–Ω–¥–µ—Ä —Ä–µ–π—Ç–∏–Ω–≥–∞ ===
function render(data, filialMap, currentIndex) {
    const content = document.getElementById('content');
    const footer = document.getElementById('footer');
    
    if (!data.length) {
        content.innerHTML = '<div class="error"><div class="error-icon">üòî</div><div>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div></div>';
        return;
    }
    
    let html = '';
    
    // –ë–ª–æ–∫ "–í–∞—à–µ –º–µ—Å—Ç–æ"
    if (currentIndex >= 0) {
        html += `<div class="my-place">
            <div class="my-place-label">–í–∞—à–µ –º–µ—Å—Ç–æ</div>
            <div class="my-place-value">${currentIndex + 1}</div>
        </div>`;
    }
    
    // –ü–æ–¥–∏—É–º (—Ç–æ–ø-3)
    if (data.length >= 3) {
        const order = [
            { idx: 1, cls: 'silver', medal: 'ü•à' },
            { idx: 0, cls: 'gold', medal: 'ü•á' },
            { idx: 2, cls: 'bronze', medal: 'ü•â' }
        ];
        
        html += '<div class="podium">';
        order.forEach(o => {
            const d = data[o.idx];
            const filial = filialMap[d.fio] || '';
            html += `<div class="podium-item ${o.cls}">
                <div class="podium-avatar">${o.medal}</div>
                <div class="podium-name">${shortName(d.fio)}</div>
                ${filial ? `<div class="podium-filial">${filial}</div>` : ''}
                <div class="podium-score">${d.score} ‚≠ê</div>
                <div class="podium-pedestal"></div>
            </div>`;
        });
        html += '</div>';
    }
    
    // –û—Å—Ç–∞–ª—å–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏
    const rest = data.slice(3);
    if (rest.length) {
        html += '<div class="section-title">–û—Å—Ç–∞–ª—å–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏</div>';
        html += '<div class="list">';
        rest.forEach((d, i) => {
            const rank = i + 4;
            const filial = filialMap[d.fio] || '';
            const isCurrent = (i + 3) === currentIndex;
            html += `<div class="item ${isCurrent ? 'current' : ''}">
                <div class="rank">${rank}</div>
                <div class="info">
                    <div class="name">${shortName(d.fio)}</div>
                    ${filial ? `<div class="filial">${filial}</div>` : ''}
                </div>
                <div class="score">${d.score}</div>
            </div>`;
        });
        html += '</div>';
    }
    
    content.innerHTML = html;
    
    // –§—É—Ç–µ—Ä
    const now = new Date().toLocaleString('ru-RU', {
        day: '2-digit', month: '2-digit', year: 'numeric',
        hour: '2-digit', minute: '2-digit'
    });
    footer.textContent = '–û–±–Ω–æ–≤–ª–µ–Ω–æ: ' + now;
}

// === –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö ===
async function loadData() {
    try {
        const headers = { 'xc-token': API_TOKEN };
        
        // 1. –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ–µ–∫—Ç—ã
        const projRes = await fetch(NOCODB_URL + '/api/v1/db/meta/projects', { headers });
        const projects = (await projRes.json()).list || [];
        const projectId = projects.find(p => p.title?.toLowerCase().includes('—Ç–µ–ª–µ–≥—Ä–∞–º'))?.id || projects[0]?.id;
        if (!projectId) throw new Error('–ü—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');
        
        // 2. –ü–æ–ª—É—á–∞–µ–º —Ç–∞–±–ª–∏—Ü—ã
        const tabRes = await fetch(NOCODB_URL + '/api/v1/db/meta/projects/' + projectId + '/tables', { headers });
        const tables = (await tabRes.json()).list || [];
        
        // 3. –î–∞–Ω–Ω—ã–µ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã "–î–µ–Ω—å 1"
        const tableId = tables.find(t => t.title === TABLE_NAME)?.id;
        if (!tableId) throw new Error('–¢–∞–±–ª–∏—Ü–∞ "' + TABLE_NAME + '" –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
        
        const dataRes = await fetch(NOCODB_URL + '/api/v1/db/data/noco/' + projectId + '/' + tableId, { headers });
        const records = (await dataRes.json()).list || [];
        
        // 4. –î–∞–Ω–Ω—ã–µ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã "–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏" –¥–ª—è —Ñ–∏–ª–∏–∞–ª–æ–≤
        const empTableId = tables.find(t => t.title === '–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏')?.id;
        const filialMap = {};
        
        if (empTableId) {
            try {
                const empRes = await fetch(NOCODB_URL + '/api/v1/db/data/noco/' + projectId + '/' + empTableId, { headers });
                const employees = (await empRes.json()).list || [];
                employees.forEach(emp => {
                    const fio = emp['–§–ò–û —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞'] || emp['–§–ò–û'] || '';
                    const filial = emp['–§–∏–ª–∏–∞–ª —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞'] || emp['–§–∏–ª–∏–∞–ª'] || '';
                    if (fio && filial) {
                        filialMap[String(fio).trim()] = String(filial).trim();
                    }
                });
            } catch (e) {
                console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∏–ª–∏–∞–ª—ã:', e);
            }
        }
        
        // 5. –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        const tabNMap = {};
        const data = records
            .map(r => {
                let fio = r['–§–ò–û —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞'] || '';
                if (!fio) {
                    for (const k of Object.keys(r)) {
                        if (k.toLowerCase().includes('—Ñ–∏–æ') && !k.toLowerCase().includes('—Ç—Ä–µ–Ω–µ—Ä')) {
                            fio = r[k] || '';
                            if (fio) break;
                        }
                    }
                }
                fio = String(fio).trim();
                
                const tabN = r['tab_nomer'] || r['Tab_nomer'] || r['Tab_n'] || '';
                if (tabN && fio) {
                    tabNMap[String(tabN).trim()] = fio;
                }
                
                return { fio, score: parseFloat(r['–û—Ü–µ–Ω–∫–∞'] || 0) || 0 };
            })
            .filter(x => x.fio)
            .sort((a, b) => b.score - a.score);
        
        // 6. –ù–∞—Ö–æ–¥–∏–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        let currentIndex = -1;
        
        // –°–Ω–∞—á–∞–ª–∞ –ø–æ fullname
        const fullname = getFullName();
        if (fullname) {
            const searchFio = fullname.toLowerCase().replace(/\s+/g, ' ');
            currentIndex = data.findIndex(d => {
                const dataFio = d.fio.toLowerCase().replace(/\s+/g, ' ');
                return dataFio === searchFio || dataFio.includes(searchFio) || searchFio.includes(dataFio);
            });
        }
        
        // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏, –ø–æ —Ç–∞–±–µ–ª—å–Ω–æ–º—É –Ω–æ–º–µ—Ä—É
        if (currentIndex < 0) {
            const tabN = getTabNomer();
            if (tabN && tabNMap[tabN]) {
                const fio = tabNMap[tabN];
                currentIndex = data.findIndex(d => d.fio === fio);
            }
        }
        
        render(data, filialMap, currentIndex);
        
    } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', e);
        document.getElementById('content').innerHTML = 
            `<div class="error">
                <div class="error-icon">‚ö†Ô∏è</div>
                <div>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>
                <div style="font-size: 12px; margin-top: 8px; opacity: 0.7;">${e.message}</div>
            </div>`;
    }
}

// === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ===
showDebug();
loadSticker();
loadData();

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
setInterval(loadData, 30000);
</script>
</body>
</html>
