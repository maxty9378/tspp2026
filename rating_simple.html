<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–µ–π—Ç–∏–Ω–≥ - –î–µ–Ω—å 1</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            color: #fff;
            min-height: 100vh;
            padding: 16px;
        }
        .header { text-align: center; padding: 20px 0; margin-bottom: 20px; }
        .header-icon { font-size: 48px; }
        .header-title { font-size: 28px; font-weight: 700; margin-top: 8px; }
        .header-sub { font-size: 14px; color: #888; margin-top: 4px; }
        
        .podium { display: flex; justify-content: center; align-items: flex-end; gap: 8px; margin: 24px 0; }
        .podium-item { display: flex; flex-direction: column; align-items: center; flex: 1; max-width: 110px; }
        .podium-avatar { width: 60px; height: 60px; border-radius: 30px; display: flex; align-items: center; justify-content: center; font-size: 28px; margin-bottom: 8px; }
        .gold .podium-avatar { width: 72px; height: 72px; font-size: 32px; background: linear-gradient(135deg, #FFD700, #FFA500); }
        .silver .podium-avatar { background: linear-gradient(135deg, #C0C0C0, #808080); }
        .bronze .podium-avatar { background: linear-gradient(135deg, #CD7F32, #8B4513); }
        .podium-name { font-size: 12px; font-weight: 600; text-align: center; margin-bottom: 2px; }
        .podium-filial { font-size: 10px; color: #888; text-align: center; margin-bottom: 4px; }
        .podium-score { font-size: 14px; font-weight: 700; padding: 4px 10px; border-radius: 12px; background: #222; }
        .gold .podium-score { background: rgba(255,215,0,0.2); color: #FFD700; }
        .podium-pedestal { width: 100%; margin-top: 10px; border-radius: 8px 8px 0 0; background: #1a1a1a; }
        .gold .podium-pedestal { height: 70px; }
        .silver .podium-pedestal { height: 50px; }
        .bronze .podium-pedestal { height: 35px; }
        
        .section-title { font-size: 12px; font-weight: 600; color: #888; text-transform: uppercase; padding: 16px 0 8px; }
        .list { background: #1a1a1a; border-radius: 12px; }
        .item { display: flex; align-items: center; padding: 12px 14px; gap: 12px; border-bottom: 1px solid #333; }
        .item:last-child { border-bottom: none; }
        .item.current { background: rgba(0,122,255,0.1); border-left: 3px solid #007AFF; }
        .rank { width: 28px; height: 28px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 600; background: #333; color: #888; }
        .item.current .rank { background: #007AFF; color: #fff; }
        .name-block { flex: 1; display: flex; flex-direction: column; }
        .name { font-size: 12px; font-weight: 500; }
        .item.current .name { font-weight: 600; color: #007AFF; }
        .filial { font-size: 10px; color: #888; margin-top: 2px; }
        .score { padding: 5px 10px; border-radius: 16px; background: rgba(0,122,255,0.2); color: #007AFF; font-weight: 700; }
        
        .my-place {
            background: rgba(0,122,255,0.15);
            border: 1px solid rgba(0,122,255,0.3);
            border-radius: 12px;
            padding: 12px 16px;
            margin: 16px 0;
            text-align: center;
        }
        .my-place-label { font-size: 11px; color: #888; margin-bottom: 4px; }
        .my-place-value { font-size: 24px; font-weight: 700; color: #007AFF; }
        
        .footer { text-align: center; padding: 20px; font-size: 12px; color: #555; }
        .loading, .error { text-align: center; padding: 60px; color: #888; }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-icon">üèÜ</div>
        <div class="header-title">–†–µ–π—Ç–∏–Ω–≥</div>
        <div class="header-sub">–î–µ–Ω—å 1 ‚Ä¢ –ú–∞—Ä–∞—Ñ–æ–Ω</div>
    </div>
    <div id="content"><div class="loading">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</div></div>
    <div class="footer" id="footer"></div>

<script>
// === –ù–ê–°–¢–†–û–ô–ö–ò ===
const NOCODB_URL = 'https://nocodb.puzzlebot.top';
const API_TOKEN = 'avKy8Ov_rNMIRMf-hgneulQKWsrXMhqmdqfc6uR1';
const TABLE_NAME = '–î–µ–Ω—å 1';

// –ö–æ—Ä–æ—Ç–∫–æ–µ –∏–º—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ "–ò–º—è –§."
function short(fio) {
    const p = fio.split(' ').filter(x => x);
    if (p.length >= 2) {
        // p[0] = –§–∞–º–∏–ª–∏—è, p[1] = –ò–º—è
        return p[1] + ' ' + p[0][0].toUpperCase() + '.';
    }
    return fio;
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–∞–±–µ–ª—å–Ω–æ–≥–æ –Ω–æ–º–µ—Ä–∞ –∏–∑ URL –∏–ª–∏ Telegram WebApp
function getTabN() {
    // –ò–∑ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    const urlParams = new URLSearchParams(window.location.search);
    let tabN = urlParams.get('Tab_n') || urlParams.get('tab_nomer');
    
    // –ò–∑ Telegram WebApp initData (–ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è tab_nomer)
    if (!tabN && window.Telegram && window.Telegram.WebApp) {
        const tg = window.Telegram.WebApp;
        if (tg.initData) {
            const initData = new URLSearchParams(tg.initData);
            tabN = initData.get('tab_nomer') || initData.get('Tab_nomer') || initData.get('Tab_n') || initData.get('tab_n');
        }
        // –¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤ initDataUnsafe
        if (!tabN && tg.initDataUnsafe) {
            tabN = tg.initDataUnsafe.tab_nomer || tg.initDataUnsafe.Tab_nomer || tg.initDataUnsafe.Tab_n;
        }
    }
    
    return tabN ? String(tabN).trim() : null;
}

// –û—Ç—Ä–∏—Å–æ–≤–∫–∞
function render(data, filialMap, currentTabN, tabNMap) {
    if (!data.length) {
        document.getElementById('content').innerHTML = '<div class="error">üòî –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
        return;
    }
    
    // –ù–∞—Ö–æ–¥–∏–º –º–µ—Å—Ç–æ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    let currentPlace = null;
    let currentIndex = -1;
    if (currentTabN && tabNMap) {
        const currentFio = tabNMap[currentTabN];
        if (currentFio) {
            currentIndex = data.findIndex(d => d.fio === currentFio);
            if (currentIndex >= 0) {
                currentPlace = currentIndex + 1;
            }
        }
    }
    
    let html = '';
    
    // –ë–ª–æ–∫ —Å –º–µ—Å—Ç–æ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if (currentPlace) {
        html += `<div class="my-place">
            <div class="my-place-label">–í–∞—à–µ –º–µ—Å—Ç–æ</div>
            <div class="my-place-value">${currentPlace}</div>
        </div>`;
    }
    
    // –ü–æ–¥–∏—É–º
    if (data.length >= 3) {
        const order = [{i:1, c:'silver', m:'ü•à'}, {i:0, c:'gold', m:'ü•á'}, {i:2, c:'bronze', m:'ü•â'}];
        html += '<div class="podium">';
        order.forEach(o => {
            const d = data[o.i];
            const filial = filialMap[d.fio] || '';
            const isCurrent = o.i === currentIndex;
            html += `<div class="podium-item ${o.c}">
                <div class="podium-avatar">${o.m}</div>
                <div class="podium-name">${short(d.fio)}</div>
                ${filial ? `<div class="podium-filial">${filial}</div>` : ''}
                <div class="podium-score">${d.score} ‚≠ê</div>
                <div class="podium-pedestal"></div>
            </div>`;
        });
        html += '</div>';
    }
    
    // –û—Å—Ç–∞–ª—å–Ω—ã–µ
    const rest = data.slice(3);
    if (rest.length) {
        html += '<div class="section-title">–û—Å—Ç–∞–ª—å–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏</div><div class="list">';
        rest.forEach((d, i) => {
            const filial = filialMap[d.fio] || '';
            const rank = i + 4;
            const isCurrent = (i + 3) === currentIndex;
            html += `<div class="item ${isCurrent ? 'current' : ''}">
                <div class="rank">${rank}</div>
                <div class="name-block">
                    <div class="name">${short(d.fio)}</div>
                    ${filial ? `<div class="filial">${filial}</div>` : ''}
                </div>
                <div class="score">${d.score}</div>
            </div>`;
        });
        html += '</div>';
    }
    
    document.getElementById('content').innerHTML = html;
    document.getElementById('footer').textContent = '–û–±–Ω–æ–≤–ª–µ–Ω–æ: ' + new Date().toLocaleString('ru-RU');
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
async function load() {
    try {
        const headers = { 'xc-token': API_TOKEN };
        
        // 1. –ü—Ä–æ–µ–∫—Ç—ã
        const projRes = await fetch(NOCODB_URL + '/api/v1/db/meta/projects', { headers });
        const projects = (await projRes.json()).list || [];
        let projectId = projects.find(p => p.title?.toLowerCase().includes('—Ç–µ–ª–µ–≥—Ä–∞–º'))?.id || projects[0]?.id;
        if (!projectId) throw new Error('–ü—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');
        
        // 2. –¢–∞–±–ª–∏—Ü—ã
        const tabRes = await fetch(NOCODB_URL + '/api/v1/db/meta/projects/' + projectId + '/tables', { headers });
        const tables = (await tabRes.json()).list || [];
        
        // 3. –î–∞–Ω–Ω—ã–µ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã "–î–µ–Ω—å 1"
        let tableId = tables.find(t => t.title === TABLE_NAME)?.id;
        if (!tableId) throw new Error('–¢–∞–±–ª–∏—Ü–∞ "–î–µ–Ω—å 1" –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
        
        const dataRes = await fetch(NOCODB_URL + '/api/v1/db/data/noco/' + projectId + '/' + tableId, { headers });
        const records = (await dataRes.json()).list || [];
        
        // 4. –î–∞–Ω–Ω—ã–µ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã "–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏" –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ñ–∏–ª–∏–∞–ª–æ–≤
        let employeesTableId = tables.find(t => t.title === '–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏')?.id;
        let filialMap = {};
        
        if (employeesTableId) {
            try {
                const empRes = await fetch(NOCODB_URL + '/api/v1/db/data/noco/' + projectId + '/' + employeesTableId, { headers });
                const employees = (await empRes.json()).list || [];
                
                employees.forEach(emp => {
                    let fio = emp['–§–ò–û —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞'] || emp['–§–ò–û'] || '';
                    if (!fio) {
                        for (const k of Object.keys(emp)) {
                            if (k.toLowerCase().includes('—Ñ–∏–æ') && !k.toLowerCase().includes('—Ç—Ä–µ–Ω–µ—Ä')) {
                                fio = emp[k] || '';
                                if (fio) break;
                            }
                        }
                    }
                    if (fio) {
                        const filial = emp['–§–∏–ª–∏–∞–ª —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞'] || emp['–§–∏–ª–∏–∞–ª'] || '';
                        if (filial) {
                            filialMap[String(fio).trim()] = String(filial).trim();
                        }
                    }
                });
            } catch (e) {
                console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∏–ª–∏–∞–ª—ã:', e);
            }
        }
        
        // 5. –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ä–µ–π—Ç–∏–Ω–≥–∞ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –º–∞–ø–ø–∏–Ω–≥–∞ Tab_n -> –§–ò–û
        const tabNMap = {}; // Tab_n -> –§–ò–û
        const result = records
            .map(r => {
                let fio = r['–§–ò–û —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞'] || '';
                if (!fio) {
                    for (const k of Object.keys(r)) {
                        if (k.toLowerCase().includes('—Ñ–∏–æ') && !k.toLowerCase().includes('—Ç—Ä–µ–Ω–µ—Ä')) {
                            fio = r[k] || '';
                            if (fio) break;
                        }
                    }
                }
                fio = String(fio).trim();
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–∞–ø–ø–∏–Ω–≥ Tab_n -> –§–ò–û
                const tabN = r['Tab_n'] || r['tab_n'] || '';
                if (tabN && fio) {
                    tabNMap[String(tabN).trim()] = fio;
                }
                
                return { fio, score: parseFloat(r['–û—Ü–µ–Ω–∫–∞'] || 0) || 0 };
            })
            .filter(x => x.fio)
            .sort((a, b) => b.score - a.score);
        
        // –ü–æ–ª—É—á–∞–µ–º Tab_n —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const currentTabN = getTabN();
        
        render(result, filialMap, currentTabN, tabNMap);
    } catch (e) {
        document.getElementById('content').innerHTML = '<div class="error">‚ö†Ô∏è ' + e.message + '</div>';
    }
}

load();
setInterval(load, 30000);
</script>
</body>
</html>

